worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;

    server {
        listen       80;
        server_name  39.97.60.191;

        root   html;
        index  index.html;

        # 启用gzip压缩
        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_types
            text/plain
            text/css
            text/xml
            text/javascript
            application/javascript
            application/xml+rss
            application/json;

        # Admin根目录精确匹配
        location = /admin {
            return 301 /admin/;
        }

        # Admin管理后台配置
        location /admin {
            alias  html/admin/dist;
            index  index.html;
            try_files $uri $uri/ @fallback;
        }

        location @fallback {
            rewrite ^.*$ /admin/index.html last;
        }

        # Frontend根目录精确匹配
        location = /frontend {
            return 301 /frontend/;
        }

        # Frontend前端配置
        location /frontend {
            alias  html/frontend/dist;
            index  index.html;
            try_files $uri $uri/ @frontend_fallback;
        }

        location @frontend_fallback {
            rewrite ^.*$ /frontend/index.html last;
        }

        # Frontend静态资源处理
        location /frontend/assets/ {
            alias  html/frontend/dist/assets/;
            expires 1y;
            add_header Cache-Control "public, max-age=31536000, immutable";

            # 确保正确的MIME类型
            location ~* \.css$ {
                add_header Content-Type text/css;
            }
            location ~* \.js$ {
                add_header Content-Type application/javascript;
            }
            location ~* \.(png|jpg|jpeg|gif|ico|svg)$ {
                add_header Content-Type image/jpeg;
            }
            location ~* \.(woff|woff2|ttf|eot)$ {
                add_header Content-Type application/font-woff;
            }
        }

        # Admin静态资源处理
        location /admin/assets/ {
            alias  html/admin/dist/assets/;
            expires 1y;
            add_header Cache-Control "public, max-age=31536000, immutable";

            # 确保正确的MIME类型
            location ~* \.css$ {
                add_header Content-Type text/css;
            }
            location ~* \.js$ {
                add_header Content-Type application/javascript;
            }
            location ~* \.(png|jpg|jpeg|gif|ico|svg)$ {
                add_header Content-Type image/jpeg;
            }
            location ~* \.(woff|woff2|ttf|eot)$ {
                add_header Content-Type application/font-woff;
            }
        }

        # API代理到后端（可选）
        location /api/ {
            proxy_pass http://localhost:33380;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # CORS设置
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS';
            add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';

            if ($request_method = 'OPTIONS') {
                return 204;
            }
        }

        # 安全头设置
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;

        # 错误页面
        error_page  404              /admin/index.html;
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }

    # HTTPS配置 - c-jeans.com（已修改证书文件名为图片匹配的c-jeans.com.pem）
    server {
        listen 443 ssl;
        server_name www.c-jeans.com c-jeans.com;

        # 核心修改：证书文件替换为图片里的c-jeans.com.pem
        ssl_certificate /usr/local/nginx/ssl/c-jeans.com.pem;
        ssl_certificate_key /usr/local/nginx/ssl/c-jeans.com.key;
        ssl_session_cache shared:SSL:1m;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1.2 TLSv1.3;

        # 安全头
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;

        # 启用gzip压缩
        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_types
            text/plain
            text/css
            text/xml
            text/javascript
            application/javascript
            application/xml+rss
            application/json;

        # ========== 新增：HTTPS下的API代理配置 ==========
        location /api/ {
            # 处理 OPTIONS 预检请求
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin * always;
                add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS' always;
                add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization' always;
                add_header Access-Control-Max-Age 3600 always;
                add_header Content-Length 0;
                add_header Content-Type text/plain;
                return 204;
            }
            
            proxy_pass http://localhost:33380;
            
            # 隐藏后端的 CORS 响应头（避免冲突）
            proxy_hide_header Access-Control-Allow-Origin;
            proxy_hide_header Access-Control-Allow-Methods;
            proxy_hide_header Access-Control-Allow-Headers;
            proxy_hide_header Access-Control-Allow-Credentials;
            proxy_hide_header Vary;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Origin "";  # 移除 Origin 头，绕过后端 CORS 检查
            
            # 超时设置
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # 禁用缓冲
            proxy_buffering off;
            proxy_request_buffering off;

            # CORS设置（由 Nginx 完全控制）
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization' always;
        }
        # ========== API代理配置结束 ==========

        # Frontend静态资源处理
        location /frontend/assets/ {
            alias  html/frontend/dist/assets/;
            expires 1y;
            add_header Cache-Control "public, max-age=31536000, immutable";

            # 确保正确的MIME类型
            location ~* \.css$ {
                add_header Content-Type text/css;
            }
            location ~* \.js$ {
                add_header Content-Type application/javascript;
            }
            location ~* \.(png|jpg|jpeg|gif|ico|svg)$ {
                add_header Content-Type image/jpeg;
            }
            location ~* \.(woff|woff2|ttf|eot)$ {
                add_header Content-Type application/font-woff;
            }
        }

        # 根路径访问前端
        location / {
            alias  html/frontend/dist/;
            index  index.html;
            try_files $uri $uri/ /index.html;
        }

        # 错误页面
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}