# 产品视频功能说明

## 功能概述

为了支持前端展示产品详情时既有图片又有视频，我们已经在产品表中增加了视频路径字段，并完善了相关的后端API接口。

## 数据库变更

### 新增字段
在 `product` 表中新增了以下字段：

```sql
ALTER TABLE product ADD COLUMN video_path VARCHAR(500) COMMENT '产品视频路径' AFTER product_images;
```

### 字段详情
- **字段名**: `video_path`
- **类型**: VARCHAR(500)
- **注释**: 产品视频路径
- **位置**: 在 `product_images` 字段之后

## 后端代码变更

### 1. 实体类更新
- **文件**: `src/main/java/com/manage/entity/Product.java`
- **变更**: 添加了 `videoPath` 属性及相关注解

```java
/**
 * 产品视频路径
 */
@Size(max = 500, message = "视频路径长度不能超过500个字符")
@Column(name = "video_path", length = 500)
private String videoPath;
```

### 2. DTO类更新
- **ProductRequest.java**: 添加 `videoPath` 字段用于创建和更新产品
- **ProductResponse.java**: 添加 `videoPath` 字段用于返回产品详情
- **ProductVideoUploadRequest.java**: 新建视频上传请求DTO

### 3. 服务层更新
- **ProductService.java**: 添加视频相关接口方法
- **ProductServiceImpl.java**: 实现视频上传和删除功能

```java
// 上传产品视频
ProductResponse uploadProductVideo(ProductVideoUploadRequest request, Long userId);

// 删除产品视频
ProductResponse deleteProductVideo(Long productId, Long userId);
```

### 4. 控制器更新
- **ProductController.java**: 添加视频相关的API接口
- **FileUploadController.java**: 添加产品视频文件上传接口

## API接口说明

### 1. 产品视频上传（文件上传）
- **URL**: `POST /api/admin/upload/product/video`
- **参数**:
  - `file`: 视频文件（支持mp4、avi、mov、wmv、flv、webm、mkv、m4v格式）
  - 最大文件大小：150MB
- **返回**:
```json
{
  "code": 200,
  "message": "产品视频上传成功",
  "data": {
    "url": "/uploads/videos/product/2025/11/13/filename.mp4",
    "fileName": "filename.mp4",
    "fileSize": "10485760"
  }
}
```

### 2. 关联视频到产品
- **URL**: `POST /api/products/video`
- **请求体**:
```json
{
  "productId": 20,
  "videoUrl": "/uploads/videos/product/2025/11/13/filename.mp4",
  "videoTitle": "产品展示视频",
  "videoDescription": "这是产品的详细介绍视频"
}
```
- **返回**: 更新后的产品信息，包含 `videoPath` 字段

### 3. 删除产品视频
- **URL**: `DELETE /api/products/{productId}/video`
- **路径参数**: `productId` - 产品ID
- **返回**: 更新后的产品信息，`videoPath` 字段为 null

### 4. 获取产品详情
- **URL**: `GET /api/products/{id}`
- **返回**: 产品详情，包含 `videoPath` 字段
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "id": 20,
    "productName": "产品名称",
    "videoPath": "/uploads/videos/test-product-video.mp4",
    // ... 其他产品字段
  }
}
```

## 前端集成建议

### 1. 产品详情页展示
前端在获取产品详情后，可以检查 `videoPath` 字段：

```javascript
if (product.videoPath) {
  // 显示视频播放器
  // 例如使用 HTML5 video 标签
  `<video controls>
    <source src="${product.videoPath}" type="video/mp4">
    您的浏览器不支持视频播放。
  </video>`
}
```

### 2. 视频上传流程
1. 先调用文件上传接口上传视频文件
2. 获取视频URL后，调用产品视频关联接口
3. 将视频URL关联到具体产品

### 3. 视频格式支持
支持的视频格式：
- MP4 (推荐)
- AVI
- MOV
- WMV
- FLV
- WebM
- MKV
- M4V

## 文件存储说明

- 视频文件存储路径：`uploads/product/videos/`
- 按日期组织目录结构：`uploads/product/videos/YYYY/MM/DD/`
- 访问URL格式：`/api/files/product/videos/YYYY/MM/DD/filename.ext`

## 测试验证

### 数据库验证
```sql
-- 查看产品表中的视频字段
SELECT id, product_name, video_path FROM product;

-- 手动更新测试数据
UPDATE product SET video_path = '/uploads/videos/test.mp4' WHERE id = 1;
```

### API测试
```bash
# 获取产品详情（包含视频路径）
curl -X GET "http://localhost:33380/api/products/20"

# 测试结果应包含 "videoPath" 字段
```

## 注意事项

1. **文件大小限制**: 单个视频文件最大150MB
2. **安全性**: 所有上传的文件都会经过类型验证
3. **存储**: 视频文件存储在服务器本地，建议后续考虑CDN加速
4. **兼容性**: 建议前端使用MP4格式以确保最佳兼容性

## 扩展建议

1. **视频转码**: 可考虑添加视频转码功能，统一转换为MP4格式
2. **缩略图生成**: 可为视频自动生成缩略图
3. **视频压缩**: 对大文件进行自动压缩处理
4. **进度显示**: 添加大文件上传的进度显示功能